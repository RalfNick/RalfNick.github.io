---
layout: post
title: "NDK开发学习笔记之javah及ndk-build"
date: 2017-12-21
description: "初学NDK开发，记录知识要点和主要操作，防止重复造轮子"
tag: Android
---

[**NDK开发学习笔记之JNI环境搭建**](https://ralfnick.github.io/2017/11/NDK%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E4%B9%8BJNI%E7%8E%AF%E5%A2%83%E5%88%9B%E5%BB%BA/)  写到 NDK 的基本使用及环境搭建。
并写了一个简单的 cpp 文件，但是有没有发现在编写 cpp 文件中的函数时，名字是不是很长，很容易写错！
那么，哟没有方法，自动生成函数名呢？没错，你猜对了，还真有这样的工具—— javah。下面就来介绍 javah 的使用以及以下小技巧，
此外还有 ndk-build 生成 so 的方法。

### 概要

> * **javah 的使用**
> * **ndk-build 的使用**

### 1. javah

上一篇讲过，jni 中函数名的书写方式，再来回顾一下。
>(1)函数名：JNIEXPORT + 返回类型 + JNICALL Java_+包名 + 类型 + 函数名（java 中声明的），
以下划线连接
>
>(2)返回值类型，是 jni 中的数据类型，若没有返回类型，则使用 void
>
>(3)默认传入两个参数 JNIEnv* env(jvm运行环境), jobject obj(调用这个函数的Java对象)


```cpp
#include <jni.h>
extern "C" {

/*
* Class:     com_ralf_www_jnitest_JniUtils
* Method:    getString
* Signature: ()Ljava/lang/String;
*/
JNIEXPORT jstring JNICALL Java_com_ralf_www_jnitest_JniUtils_getString
(JNIEnv *env, jclass jc){

const char* ch = "String From JNI";
return env->NewStringUTF(ch);
}

}
```
但是这么长的名字很容易写错，特别在包名中出现一些特殊符号时，如，下划线（com.example.my_jni）,这时候可以使用 javah 来
自动生成头文件，里面会有完整的函数名。下面就来看一下实现的步骤。
主要是 4 个步骤：

> * 利用 javah 命令来编译出对应的头文件，
> * 建立 cpp 文件，如 MyJni.cpp，然后复制头文件中函数名，粘贴进去，然后再编写函数的方法体
> * 在 android.mk 中添加自己新建立的 cpp 文件名
> *  编译 so 库

---
**详细说明：**

**(1)** 在 main 文件夹下建立 jni 文件夹
切换到 java 文件夹下，shift +右键，打开命令行窗口，执行下面命令

```java
javah -classpath ./java -d ../jni com.ralf.www.jnitest.JniUtils
```

注意：

>* -classpath 表示类文件路径
>
>* ./java 表示java当前的文件夹
>
>* -d表示生成头文件所在路径
>
>* ../jni 表示 jni 文件夹下，这样写是因为当前文件夹时 java 文件夹下，..表示上一级文件夹，即 main，再加上 /jni 表示 jni 文件夹
>
>* com.ralf.www.jnitest.JniUtils，表示需要编译的类文件，也就是包名+类名（也就是包含 native 方法的类文件）

![GBK编译](https://github.com/RalfNick/PicRepository/raw/master/jni/javah.PNG)

忽略提示错误，**“错误，编码 GBK 的不可映射字符”**，此时，对应的头文件已经生成。可以打开看到里面的内容，如下。

```cpp

/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class com_ralf_www_jnitest_JniUtils */

#ifndef _Included_com_ralf_www_jnitest_JniUtils
#define _Included_com_ralf_www_jnitest_JniUtils
#ifdef __cplusplus
extern "C" {
#endif
/*
* Class:     com_ralf_www_jnitest_JniUtils
* Method:    getString
* Signature: ()Ljava/lang/String;
*/
JNIEXPORT jstring JNICALL Java_com_ralf_www_jnitest_JniUtils_getString
(JNIEnv *, jclass);

#ifdef __cplusplus
}
#endif
#endif
```

**(2)** 在 jni 文件及下新建一个源文件 .cpp 文件，拷贝头文件中的内容到 cpp 文件中，只保留 extern "C"{。。。} 中的
内容

注意，函数的参数(JNIEnv *, jclass)中，需要更改下，(JNIEnv *env, jclass jc)

**(3)** 在 android.mk 中添加需要编译的文件，即 MyJni.cpp

```cpp
LOCAL_PATH := $(call my-dir)

include $(CLEAR_VARS)

LOCAL_MODULE    := libjnitest
LOCAL_SRC_FILES := MyJni.cpp

include $(BUILD_SHARED_LIBRARY)
```

### 2.编译 so 库

> 方式一：ndk-build
>
> 方式二：利用gradle


（1）ndk-build：

ndk-build 文件是 Android NDK r4 中引入的一个 shell 脚本。其用途是调用正确的 NDK 构建脚本。上一篇文章中也已经给出 NDK 的相关介绍，脑图中列举了基本的NDK先关知识点。
要想使用 ndk-build 命令，首先需要将该命令添加到环境变量，要不然使用会有点麻烦，添加环境变量的操作这里就不赘述了，请自行百度、谷歌。
主要说下怎么操作：
切换到工程的 main 文件夹下--->shift + 右键 开启命令行窗口--->输入 ndk-build 命令执行编译，生成 so 库。
So 库放置的位置是在 main 文件夹下的 libs 文件夹，里面有不同机器的 so 库，
生成不同版本的 so 的设置在 Application.mk 文件中设置，本例中设置 APP_ABI :=all


![lib路径](https://github.com/RalfNick/PicRepository/raw/master/jni/libs.PNG)

（2）利用 gradle 配置

a.    指定 NDK 路径


在 local.properties 文件下设置

```cpp
ndk.dir=D\:\\Android\\android-ndk-r10e
sdk.dir=D\:\\Android\\sdk
```

b.    指定编译的 Android.mk 文件

```cpp
android {
…
externalNativeBuild{


//指定 Android.mk 文件
ndkBuild{
path 'src/main/jni/Android.mk'
}
}
}
```

c.    指定property.gradle文件设置
```cpp
android.useDeprecatedNdk=true
```
这些操作在上一篇文章中都讲过了，多熟悉几次对你来说应该很简单。


生成的 so 库所在路径,稍微有点隐蔽，看下图

![so路径](https://github.com/RalfNick/PicRepository/raw/master/jni/gradle%E7%94%9F%E6%88%90%E7%9A%84%E8%B7%AF%E5%BE%84.PNG)

（3）利用 gradle 配置还有一个快捷方式，一键完成。
在 jni 文件夹上右键选择 “Link C++ Project with Gradle” 一项，然后选择你工程中 android.mk 文件，这样就完成了配置。



### 3.小技巧
个人认为这个小技巧真的很好用。

（1）命令快捷窗口

利用 javah 命令生成头文件的命令可以在 terminal 窗口输入

![javah快捷工具](https://github.com/RalfNick/PicRepository/raw/master/jni/terminal%E7%AA%97%E5%8F%A3-javah.PNG)


同样，ndk-build 命令也可以在 terminal 窗口执行

![ndk-build快捷工具](https://github.com/RalfNick/PicRepository/raw/master/jni/terminal%E7%AA%97%E5%8F%A3-ndk-build.PNG)

（2）将命令设置成快捷工具

在 Settings----External Tools 中设置快捷工具
在设置界面，找到 External Tools，如下图，然后点击右边方框的 “+”，添加 javah 和 ndk 命令快捷工具

>* javah 快捷工具
>
![external工具](https://github.com/RalfNick/PicRepository/raw/master/jni/external%E5%B7%A5%E5%85%B7%E6%B7%BB%E5%8A%A0.PNG)


**参数设置：**
>1.Program: $JDKPath$\bin\javah.exe 这里配置的是 javah.exe 的路径
>
>2.Parametes: -classpath . -jni -d $ModuleFileDir$/src/main/jni $FileClass$ 这里 $FileClass$ 指的是要执行操作的类名（包名.类名），$ModuleFileDir$/src/main/jni表示生成的文件保存在这个module目录的src/main/jni目录下。
>
>3.Working: $ModuleFileDir$\src\main\java


**使用方式：**
选中 java 文件--->右键---> External Tools--->javah-jni，将生成 jni 文件夹以及文件夹下的包名.类名的.h头文件 （名字过长，我们可以自己重命名）。


>* ndk-build 命令快捷方式
>
![ndk编译工具](https://github.com/RalfNick/PicRepository/raw/master/jni/ndk%E7%BC%96%E8%AF%91%E5%B7%A5%E5%85%B7.PNG)


**设置参数：**

>1.Program: F:\apk\sdk\ndk-bundle\ndk-build.cmd 这里配置的是 ndk 下的 ndk-build.cmd 的路径（根据实际情况填写）
>
>2.Working: $ModuleFileDir$\src\main\

**使用方式：**
选中 C/C++ 文件--->右键--->ExternalTools--->ndk-build，将在 main 文件夹下生成 libs 文件夹以及多个 so 文件，我们可以移动至 jniLibs 目录下去。



当然，还有有一种使用 Cmakelist 方式使用 jni 的方法，这种方法时 AS 新增的功能，后面的文章会介绍该方式的使用方法，敬请期待！

[代码地址](https://github.com/RalfNick/JniPractice.git)
